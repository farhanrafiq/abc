{% extends "admin/base.html" %}

{% block title %}Dashboard - ABC Publishing Kashmir Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-calendar me-1"></i>This Month
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-period="today">Today</a></li>
                <li><a class="dropdown-item" href="#" data-period="week">This Week</a></li>
                <li><a class="dropdown-item active" href="#" data-period="month">This Month</a></li>
                <li><a class="dropdown-item" href="#" data-period="year">This Year</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Stats Cards Row -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-shopping-cart fa-2x text-primary"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-muted">Today's Orders</div>
                    <div class="stats-number" id="today-orders">{{ today_orders }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-rupee-sign fa-2x text-success"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-muted">Today's Sales</div>
                    <div class="stats-number" id="today-sales">{{ format_currency(today_sales) }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-chart-line fa-2x text-info"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-muted">MTD Orders</div>
                    <div class="stats-number" id="mtd-orders">{{ mtd_orders }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-money-bill-wave fa-2x text-warning"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-muted">MTD Sales</div>
                    <div class="stats-number" id="mtd-sales">{{ format_currency(mtd_sales) }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sales Overview</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Top Categories</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="small text-muted">Average Order Value</div>
                    <div class="stats-number">{{ format_currency(aov) }}</div>
                </div>
                <i class="fas fa-calculator fa-2x text-secondary"></i>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="small text-muted">Low Stock Items</div>
                    <div class="stats-number" id="low-stock-count">{{ low_stock_products|length }}</div>
                </div>
                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="small text-muted">Pending Reviews</div>
                    <div class="stats-number" id="pending-reviews">{{ pending_reviews }}</div>
                </div>
                <i class="fas fa-star fa-2x text-info"></i>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="stats-card">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="small text-muted">Total Products</div>
                    <div class="stats-number">{{ products_count or 0 }}</div>
                </div>
                <i class="fas fa-book fa-2x text-primary"></i>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row g-4 mb-4">
    <!-- Recent Orders -->
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Orders</h5>
                <a href="{{ url_for('admin.orders') }}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body">
                {% if recent_orders %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('admin.order_detail', order_id=order.id) }}" 
                                       class="text-decoration-none">
                                        #{{ order.id }}
                                    </a>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-medium">{{ order.user.name if order.user else 'Guest' }}</span>
                                        <small class="text-muted">{{ order.email }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if order.status.value == 'Delivered' else 'primary' if order.status.value == 'Shipped' else 'warning' }}">
                                        {{ order.status.value }}
                                    </span>
                                </td>
                                <td class="fw-bold">{{ format_currency(order.grand_total_inr) }}</td>
                                <td>{{ order.created_at.strftime('%b %d, %Y') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('admin.order_detail', order_id=order.id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <p>No recent orders</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Low Stock Products -->
    <div class="col-xl-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Low Stock Alert</h5>
                <a href="{{ url_for('admin.products') }}?filter=low_stock" class="btn btn-outline-warning btn-sm">View All</a>
            </div>
            <div class="card-body">
                {% if low_stock_products %}
                <div class="list-group list-group-flush">
                    {% for product in low_stock_products[:5] %}
                    <div class="list-group-item d-flex align-items-center px-0">
                        <img src="{{ url_for('static', filename=product.cover_image) if product.cover_image else url_for('static', filename='images/no-cover.jpg') }}" 
                             alt="{{ product.title }}" 
                             class="rounded me-3"
                             style="width: 40px; height: 50px; object-fit: cover;">
                        <div class="flex-grow-1">
                            <div class="fw-medium text-truncate">{{ product.title }}</div>
                            <small class="text-danger">
                                Only {{ product.inventory.stock_on_hand }} left
                            </small>
                        </div>
                        <a href="{{ url_for('admin.product_edit', product_id=product.id) }}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                    <p>All products are well stocked!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Row -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.product_new') }}" class="btn btn-primary w-100">
                            <i class="fas fa-plus mb-2 d-block"></i>Add Product
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.orders') }}" class="btn btn-success w-100">
                            <i class="fas fa-shopping-cart mb-2 d-block"></i>View Orders
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.author_new') }}" class="btn btn-info w-100">
                            <i class="fas fa-user-edit mb-2 d-block"></i>Add Author
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.reviews') }}" class="btn btn-warning w-100">
                            <i class="fas fa-star mb-2 d-block"></i>Reviews
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.export_products') }}" class="btn btn-secondary w-100">
                            <i class="fas fa-download mb-2 d-block"></i>Export Data
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a href="{{ url_for('admin.settings') }}" class="btn btn-dark w-100">
                            <i class="fas fa-cog mb-2 d-block"></i>Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshDashboard() {
    location.reload();
}

// Period filter functionality
document.querySelectorAll('[data-period]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const period = this.dataset.period;
        
        // Remove active class from all items
        document.querySelectorAll('[data-period]').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to clicked item
        this.classList.add('active');
        
        // Update button text
        const button = document.querySelector('.dropdown-toggle');
        button.innerHTML = `<i class="fas fa-calendar me-1"></i>${this.textContent}`;
        
        // Here you would typically reload data for the selected period
        console.log('Selected period:', period);
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.stats-card.updated .stats-number {
    animation: pulse 1s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}
