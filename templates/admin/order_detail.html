{% extends "admin/base.html" %}

{% block title %}Order #{{ order.id }} - ABC Publishing Kashmir Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">Order #{{ order.id }}</h1>
        <p class="text-muted mb-0">
            Placed on {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('admin.order_invoice', order_id=order.id) }}" 
           class="btn btn-outline-info">
            <i class="fas fa-file-invoice me-1"></i>Download Invoice
        </a>
        <a href="{{ url_for('admin.orders') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Orders
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-xl-8">
        <!-- Order Status Timeline -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Order Timeline</h5>
            </div>
            <div class="card-body">
                <div class="order-timeline">
                    <div class="timeline-item {{ 'active' if order.status.value in ['Pending', 'Paid', 'Packed', 'Shipped', 'Delivered'] else '' }}">
                        <div class="timeline-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Order Placed</h6>
                            <small class="text-muted">{{ order.created_at.strftime('%b %d, %Y at %I:%M %p') }}</small>
                        </div>
                    </div>
                    
                    {% if order.status.value in ['Paid', 'Packed', 'Shipped', 'Delivered'] %}
                    <div class="timeline-item active">
                        <div class="timeline-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Payment Confirmed</h6>
                            <small class="text-muted">{{ order.payment_method.value if order.payment_method else 'Unknown' }}</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if order.status.value in ['Packed', 'Shipped', 'Delivered'] %}
                    <div class="timeline-item active">
                        <div class="timeline-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Order Packed</h6>
                            <small class="text-muted">Ready for shipment</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if order.status.value in ['Shipped', 'Delivered'] %}
                    <div class="timeline-item active">
                        <div class="timeline-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Order Shipped</h6>
                            {% if order.shipments %}
                                {% for shipment in order.shipments %}
                                <small class="text-muted d-block">
                                    Carrier: {{ shipment.carrier or 'Not specified' }}
                                </small>
                                <small class="text-muted d-block">
                                    Tracking: {{ shipment.tracking_no or 'Will be updated soon' }}
                                </small>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="timeline-item {{ 'active' if order.status.value == 'Delivered' else '' }}">
                        <div class="timeline-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="timeline-content">
                            <h6>Delivered</h6>
                            {% if order.status.value == 'Delivered' %}
                            <small class="text-muted">Order delivered successfully</small>
                            {% else %}
                            <small class="text-muted">Pending delivery</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Order Items ({{ order.items.count() }} items)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-borderless">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ url_for('static', filename=item.product.cover_image) if item.product and item.product.cover_image else url_for('static', filename='images/no-cover.jpg') }}" 
                                             alt="{{ item.title_snapshot }}" 
                                             class="rounded me-3"
                                             style="width: 50px; height: 60px; object-fit: cover;">
                                        <div>
                                            <div class="fw-medium">{{ item.title_snapshot }}</div>
                                            {% if item.product %}
                                            <small class="text-muted">
                                                <a href="{{ url_for('admin.product_edit', product_id=item.product.id) }}" 
                                                   class="text-decoration-none">
                                                    Edit Product
                                                </a>
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <code class="text-muted">{{ item.sku_snapshot }}</code>
                                </td>
                                <td class="fw-medium">{{ format_currency(item.unit_price_inr) }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.quantity }}</span>
                                </td>
                                <td class="fw-bold text-success">{{ format_currency(item.line_total_inr) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Order Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Order Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Update Status</label>
                        <form method="post" action="{{ url_for('admin.update_order_status', order_id=order.id) }}">
                            <div class="input-group">
                                <select name="status" class="form-select">
                                    <option value="Pending" {% if order.status.value == 'Pending' %}selected{% endif %}>Pending</option>
                                    <option value="Paid" {% if order.status.value == 'Paid' %}selected{% endif %}>Paid</option>
                                    <option value="Packed" {% if order.status.value == 'Packed' %}selected{% endif %}>Packed</option>
                                    <option value="Shipped" {% if order.status.value == 'Shipped' %}selected{% endif %}>Shipped</option>
                                    <option value="Delivered" {% if order.status.value == 'Delivered' %}selected{% endif %}>Delivered</option>
                                    <option value="Cancelled" {% if order.status.value == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                                    <option value="Refunded" {% if order.status.value == 'Refunded' %}selected{% endif %}>Refunded</option>
                                </select>
                                <button type="submit" class="btn btn-primary">Update</button>
                            </div>
                        </form>
                    </div>
                    
                    {% if order.status.value == 'Shipped' %}
                    <div class="col-md-6">
                        <label class="form-label">Add Tracking Info</label>
                        <form method="post" action="#" class="tracking-form">
                            <div class="input-group">
                                <input type="text" name="tracking_no" class="form-control" 
                                       placeholder="Tracking Number" required>
                                <button type="submit" class="btn btn-outline-primary">Add</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-info" 
                            onclick="sendOrderEmail({{ order.id }})">
                        <i class="fas fa-envelope me-1"></i>Send Confirmation Email
                    </button>
                    
                    {% if order.status.value not in ['Delivered', 'Cancelled'] %}
                    <button type="button" class="btn btn-outline-warning" 
                            onclick="cancelOrder({{ order.id }})">
                        <i class="fas fa-ban me-1"></i>Cancel Order
                    </button>
                    {% endif %}
                    
                    {% if order.payment_status.value == 'Paid' and order.status.value not in ['Refunded'] %}
                    <button type="button" class="btn btn-outline-danger" 
                            onclick="refundOrder({{ order.id }})">
                        <i class="fas fa-undo me-1"></i>Process Refund
                    </button>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-secondary" 
                            data-bs-toggle="modal" data-bs-target="#notesModal">
                        <i class="fas fa-sticky-note me-1"></i>Add Internal Notes
                    </button>
                </div>
            </div>
        </div>

        <!-- Customer Notes -->
        {% if order.notes %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Customer Notes</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ order.notes }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-xl-4">
        <!-- Order Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                <div class="order-summary">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>{{ format_currency(order.subtotal_inr) }}</span>
                    </div>
                    {% if order.discount_inr > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Discount:</span>
                        <span>-{{ format_currency(order.discount_inr) }}</span>
                    </div>
                    {% endif %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping:</span>
                        <span>{{ format_currency(order.shipping_inr) if order.shipping_inr > 0 else 'Free' }}</span>
                    </div>
                    {% if order.tax_inr > 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax:</span>
                        <span>{{ format_currency(order.tax_inr) }}</span>
                    </div>
                    {% endif %}
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong class="text-success">{{ format_currency(order.grand_total_inr) }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Customer Information</h5>
            </div>
            <div class="card-body">
                <div class="customer-info">
                    {% if order.user %}
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-user-circle fa-2x text-muted me-3"></i>
                        <div>
                            <div class="fw-medium">{{ order.user.name }}</div>
                            <small class="text-muted">Registered Customer</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-user fa-2x text-muted me-3"></i>
                        <div>
                            <div class="fw-medium">Guest Customer</div>
                            <small class="text-muted">One-time purchase</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="contact-info">
                        <div class="mb-2">
                            <i class="fas fa-envelope text-muted me-2"></i>
                            <a href="mailto:{{ order.email }}" class="text-decoration-none">{{ order.email }}</a>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-phone text-muted me-2"></i>
                            <a href="tel:{{ order.phone }}" class="text-decoration-none">{{ order.phone }}</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Payment Details</h5>
            </div>
            <div class="card-body">
                <div class="payment-info">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Method:</span>
                        <span class="fw-medium">{{ order.payment_method.value if order.payment_method else 'Not specified' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Status:</span>
                        <span class="badge bg-{{ 'success' if order.payment_status.value == 'Paid' else 'warning' if order.payment_status.value == 'Unpaid' else 'danger' }}">
                            {{ order.payment_status.value }}
                        </span>
                    </div>
                    {% if order.razorpay_order_id %}
                    <div class="mt-3">
                        <small class="text-muted d-block">Razorpay Order ID:</small>
                        <code class="small">{{ order.razorpay_order_id }}</code>
                    </div>
                    {% endif %}
                    {% if order.razorpay_payment_id %}
                    <div class="mt-2">
                        <small class="text-muted d-block">Payment ID:</small>
                        <code class="small">{{ order.razorpay_payment_id }}</code>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Shipping Address -->
        {% if order.shipping_address %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Shipping Address</h5>
            </div>
            <div class="card-body">
                <address class="mb-0">
                    <strong>{{ order.shipping_address.name }}</strong><br>
                    {{ order.shipping_address.line1 }}<br>
                    {% if order.shipping_address.line2 %}{{ order.shipping_address.line2 }}<br>{% endif %}
                    {{ order.shipping_address.city }}, {{ order.shipping_address.district }}<br>
                    {{ order.shipping_address.state }} - {{ order.shipping_address.pincode }}<br>
                    {{ order.shipping_address.country }}
                </address>
            </div>
        </div>
        {% endif %}

        <!-- Billing Address -->
        {% if order.billing_address and order.billing_address != order.shipping_address %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Billing Address</h5>
            </div>
            <div class="card-body">
                <address class="mb-0">
                    <strong>{{ order.billing_address.name }}</strong><br>
                    {{ order.billing_address.line1 }}<br>
                    {% if order.billing_address.line2 %}{{ order.billing_address.line2 }}<br>{% endif %}
                    {{ order.billing_address.city }}, {{ order.billing_address.district }}<br>
                    {{ order.billing_address.state }} - {{ order.billing_address.pincode }}<br>
                    {{ order.billing_address.country }}
                </address>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Internal Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Internal Notes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="#" id="notesForm">
                    <div class="mb-3">
                        <label for="internal_notes" class="form-label">Add Note</label>
                        <textarea name="notes" id="internal_notes" class="form-control" 
                                  rows="4" placeholder="Internal notes (not visible to customer)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="notesForm" class="btn btn-primary">Save Note</button>
            </div>
        </div>
    </div>
</div>

<script>
function sendOrderEmail(orderId) {
    if (confirm('Send order confirmation email to customer?')) {
        fetch(`/admin/api/orders/${orderId}/send-confirmation`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            AdminManager.showToast(data.message || 'Email sent successfully', data.success ? 'success' : 'error');
        })
        .catch(error => {
            AdminManager.showToast('Failed to send email', 'error');
        });
    }
}

function cancelOrder(orderId) {
    if (confirm('Are you sure you want to cancel this order? This action cannot be undone.')) {
        fetch(`/admin/api/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            AdminManager.showToast(data.message || 'Order cancelled', data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1500);
            }
        })
        .catch(error => {
            AdminManager.showToast('Failed to cancel order', 'error');
        });
    }
}

function refundOrder(orderId) {
    if (confirm('Process refund for this order? This will initiate a refund through the payment gateway.')) {
        fetch(`/admin/api/orders/${orderId}/refund`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            AdminManager.showToast(data.message || 'Refund processed', data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => location.reload(), 1500);
            }
        })
        .catch(error => {
            AdminManager.showToast('Failed to process refund', 'error');
        });
    }
}
</script>

<style>
.order-timeline {
    position: relative;
    padding-left: 30px;
}

.order-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-icon {
    position: absolute;
    left: -22px;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

.timeline-item.active .timeline-icon {
    background: #E86A17;
}

.timeline-content h6 {
    margin-bottom: 2px;
    color: #3B2A22;
}

.order-summary > div {
    padding: 0.25rem 0;
}
</style>
{% endblock %}
