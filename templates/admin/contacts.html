{% extends "admin/base.html" %}
{% set active_page = 'contacts' %}

{% block title %}Contact Forms{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title">
        <i class="fas fa-envelope me-2"></i>
        Contact Form Management
    </h1>
    <div class="quick-actions">
        <a href="{{ url_for('admin.contacts') }}" class="btn btn-outline-primary">
            <i class="fas fa-refresh me-1"></i> Refresh
        </a>
    </div>
</div>

<!-- Filters -->
<div class="table-card mb-4">
    <div class="table-header">
        <form method="GET" class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" name="search" 
                           value="{{ search }}" placeholder="Search by name, email, or subject">
                </div>
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">All Status</option>
                    <option value="unread" {{ 'selected' if selected_status == 'unread' else '' }}>Unread</option>
                    <option value="read" {{ 'selected' if selected_status == 'read' else '' }}>Read</option>
                    <option value="resolved" {{ 'selected' if selected_status == 'resolved' else '' }}>Resolved</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-1"></i> Filter
                </button>
            </div>
            <div class="col-md-3 text-end">
                <span class="text-muted">{{ contacts.total }} total contacts</span>
            </div>
        </form>
    </div>
</div>

<!-- Contacts Table -->
<div class="table-card">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Subject</th>
                    <th>Status</th>
                    <th>Received</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for contact in contacts.items %}
                <tr class="{{ 'table-warning' if contact.status == 'unread' else '' }}">
                    <td>
                        <strong>{{ contact.name }}</strong>
                        {% if contact.phone %}
                        <br><small class="text-muted">{{ contact.phone }}</small>
                        {% endif %}
                    </td>
                    <td>{{ contact.email }}</td>
                    <td>
                        <a href="{{ url_for('admin.contact_detail', contact_id=contact.id) }}" 
                           class="text-decoration-none">
                            {{ contact.subject }}
                        </a>
                        {% if contact.status == 'unread' %}
                        <i class="fas fa-circle text-warning ms-2" style="font-size: 0.5rem;"></i>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge status-{{ contact.status }}">
                            {% if contact.status == 'unread' %}
                                <i class="fas fa-envelope me-1"></i>
                            {% elif contact.status == 'read' %}
                                <i class="fas fa-envelope-open me-1"></i>
                            {% else %}
                                <i class="fas fa-check-circle me-1"></i>
                            {% endif %}
                            {{ contact.status.title() }}
                        </span>
                    </td>
                    <td>
                        <span data-bs-toggle="tooltip" title="{{ contact.created_at.strftime('%Y-%m-%d %H:%M:%S') }}">
                            {{ moment(contact.created_at).fromNow() }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('admin.contact_detail', contact_id=contact.id) }}" 
                               class="btn btn-outline-primary" data-bs-toggle="tooltip" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if contact.status != 'resolved' %}
                            <button type="button" class="btn btn-outline-success" 
                                    onclick="quickRespond({{ contact.id }})" 
                                    data-bs-toggle="tooltip" title="Quick Respond">
                                <i class="fas fa-reply"></i>
                            </button>
                            {% endif %}
                            <form method="POST" action="{{ url_for('admin.delete_contact', contact_id=contact.id) }}" 
                                  class="d-inline" onsubmit="return confirm('Delete this contact?')">
                                <button type="submit" class="btn btn-outline-danger btn-delete" 
                                        data-bs-toggle="tooltip" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No contact forms found</p>
                            {% if search or selected_status %}
                            <a href="{{ url_for('admin.contacts') }}" class="btn btn-sm btn-outline-primary">
                                Clear Filters
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if contacts.pages > 1 %}
    <div class="d-flex justify-content-between align-items-center p-3">
        <small class="text-muted">
            Showing {{ contacts.per_page * (contacts.page - 1) + 1 }} to 
            {{ contacts.per_page * (contacts.page - 1) + contacts.items|length }} of 
            {{ contacts.total }} entries
        </small>
        
        <nav>
            <ul class="pagination pagination-sm mb-0">
                {% if contacts.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.contacts', page=contacts.prev_num, search=search, status=selected_status) }}">
                        Previous
                    </a>
                </li>
                {% endif %}
                
                {% for page_num in contacts.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != contacts.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.contacts', page=page_num, search=search, status=selected_status) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">â€¦</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if contacts.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.contacts', page=contacts.next_num, search=search, status=selected_status) }}">
                        Next
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Quick Response Modal -->
<div class="modal fade" id="quickResponseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Response</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickResponseForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Message Preview:</label>
                        <div id="messagePreview" class="border rounded p-3 bg-light mb-3"></div>
                    </div>
                    <div class="mb-3">
                        <label for="response" class="form-label">Your Response *</label>
                        <textarea class="form-control" name="response" id="response" rows="5" 
                                  placeholder="Type your response to the customer..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i> Send Response
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Quick response function
function quickRespond(contactId) {
    // Fetch contact details
    fetch(`/admin/contacts/${contactId}`)
        .then(response => response.text())
        .then(html => {
            // Extract message from the response (this is simplified)
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const messageElement = doc.querySelector('.contact-message');
            const subjectElement = doc.querySelector('.contact-subject');
            
            if (messageElement && subjectElement) {
                document.getElementById('messagePreview').innerHTML = 
                    `<strong>Subject:</strong> ${subjectElement.textContent}<br><br>
                     <strong>Message:</strong><br>${messageElement.innerHTML}`;
            }
            
            // Set form action
            document.getElementById('quickResponseForm').action = `/admin/contacts/${contactId}/respond`;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('quickResponseModal')).show();
        })
        .catch(error => {
            console.error('Error fetching contact details:', error);
            alert('Error loading contact details');
        });
}

// Auto-refresh unread count every 30 seconds
setInterval(function() {
    fetch('/admin/api/contacts/unread-count')
        .then(response => response.json())
        .then(data => {
            if (data.count > 0) {
                document.title = `(${data.count}) Contact Forms - ABC Publishing Kashmir`;
            }
        })
        .catch(error => console.error('Error fetching unread count:', error));
}, 30000);
</script>
{% endblock %}